
# Resultados

El presente análisis tiene como objetivo identificar los principales patrones y tendencias de consumo en Estambul a partir de los datos procesados. Se analizan factores como la demografía de los consumidores, categorías de productos preferidos, métodos de pago más utilizados,  distribución del consumo en los distintos centros comerciales de la ciudad y tendencia de consumo por centro comercial en el periodo muestreado.


## Características demográficas de los consumidores

En la muestra analizada, el 60 % de las compras las realizaron mujeres, frente a un 40 % de hombres (Figura \@ref(fig:figinf0)). 

Al comparar la distribución de edades por sexo (Figura \@ref(fig:figinf1)), vemos que ambas curvas de densidad son prácticamente superponibles y mantienen una forma casi uniforme entre los 18 y los 69 años. Según la Tabla \@ref(tab:tabla-resultado1), la mediana de edad (Q2) es de 43 años, lo que significa que la mitad de los compradores tiene 43 años o menos, y el tercer cuartil (Q3) se ubica en 53 años, de modo que solo el 25% supera esa edad. El coeficiente de variación de la edad es de aproximadamente 34%, lo cual indica una dispersión moderada de la edad alrededor de la media.




```{r figinf0,fig.cap="Distribución de sexo.", echo=FALSE}

# Recodeamos 'gender' a Español y calculamos frecuencias
df_gender <- datos_mod7 %>% 
  mutate(
    gender = factor(
      gender,
      levels = c("female", "male"),
      labels = c("Femenino", "Masculino")
    )
  ) %>% 
  count(gender) %>% 
  mutate(
    prop     = n / sum(n),                 
    etiqueta = percent(prop, accuracy = 1) 
  )

# Gráfico sin cuadrícula con etiquetas en español
plot_gender_bar <- ggplot(df_gender, aes(x = gender, y = prop, fill = gender)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = etiqueta), vjust = -0.4, size = 5) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    limits = c(0, max(df_gender$prop) * 1.10),
    expand = expansion(mult = c(0, .02))
  ) +
  scale_fill_manual(values = c("#DB735C", "#2A91A2")) +
  labs(
    x     = "Sexo",
    y     = "Porcentaje",
    title = ""
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title        = element_text(size = 16, face = "plain"),
    axis.title.x      = element_text(size = 16, face = "plain"),
    axis.title.y      = element_text(size = 16, face = "plain"),
    axis.text         = element_text(size = 14, face = "plain"),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank()
  )

plot_gender_bar


```


```{r figinf1,fig.cap="Distribución de Edad vs. Sexo.", echo=FALSE}

# Box-plot Edad ~ Sexo  
plot_box <- ggplot(datos_mod7, aes(gender, age)) +
  geom_boxplot(colour = "#2A91A2", alpha = 0.8) +
  labs(x = "Sexo", y = "Edad (años)") +
  theme_minimal(base_size = 15) +
  theme(
    panel.grid.major = element_blank(),   # ← sin cuadrícula
    panel.grid.minor = element_blank()
  )

# Densidad de Edad por Sexo 
plot_density <- ggplot(datos_mod7, aes(age, colour = gender)) +
  geom_density(linewidth = 1) +
  labs(x = "Edad (años)", y = "Densidad") +
  theme_minimal(base_size = 15) +
  theme(
    legend.title     = element_blank(),
    panel.grid.major = element_blank(),   # ← sin cuadrícula
    panel.grid.minor = element_blank()
  )

# Disposición vertical (2 filas) 
grid.arrange(plot_box, plot_density, ncol = 1)

```



```{r tabla-resultado1, eval=TRUE,echo=FALSE}

tabla_edad <- datos_mod7 %>% 
  group_by(gender) %>%              # elimina esta línea si no quieres desglosar
  summarise(
    n    = n(),
    Min  = min(age, na.rm = TRUE),
    Q1   = quantile(age, 0.25, na.rm = TRUE),
    Q2   = quantile(age, 0.50, na.rm = TRUE),
    Q3   = quantile(age, 0.75, na.rm = TRUE),
    Max  = max(age, na.rm = TRUE),
    CV   = sd(age, na.rm = TRUE) / mean(age, na.rm = TRUE)  # coef. de variación
  ) %>% 
  mutate(CV = round(CV, 3))          # redondea a tres decimales

# Mostrar la tabla
knitr::kable(
  tabla_edad,
  booktabs = TRUE,
  caption = "Estadísticas de Edad (años) por Sexo. Se muestran el número de registros \
(n), mínimo (Min), cuartiles Q1–Q3, mediana (Q2), máximo (Max) y el coeficiente \
de variación (CV)."
)

```

Para caracterizar de manera precisa los hábitos de consumo en Estambul, es fundamental reconocer que las preferencias, el poder adquisitivo y los canales de compra varían según la etapa de vida. Por ello, en este informe se adopta seis tramos etarios que reflejan diferencias demográficas y de comportamiento:

- **18–24 años**  
  Jóvenes que transitan entre la educación y la incorporación al mercado laboral. 
  
- **25–34 años**  
  Adultos jóvenes y profesionales en expansión de carrera y posible formación de pareja o inicio de familia. 
  
- **35–44 años**  
  Familias jóvenes con hijos pequeños. 

- **45–54 años**  
  Profesionales senior y familias consolidadas. 

- **55–64 años**  
  Pre-jubilados.

- **65–69 años**  
  Jubilados activos.




En la Figura \@ref(fig:figinf00) se aprecia que la distribución de compradores por rango de edad es prácticamente idéntica en mujeres y hombres. Ambos sexos concentran la mayor proporción en el tramo 35–44 años (20% femenino vs. 19 % masculino), seguidos de los rangos 25–34, 45–54 y 55–64 (todos en torno al 19 %). El grupo 18–24 aporta un 15–16% y el de 65–69 apenas el 8%, siendo el de menor representación en ambos casos. Esto confirma que la actividad de compra se centra principalmente en la población adulta joven y de mediana edad, sin diferencias relevantes entre géneros.



```{r figinf00,fig.cap="Distribución de compradores por tramo de edad y sexo.", echo=FALSE}

datos_mod7 %>% 
  mutate(
    tramo = cut(
      age,
      breaks = c(18, 25, 35, 45, 55, 65, 69),
      labels = c("18–24", "25–34", "35–44", "45–54", "55–64", "65–69"),
      include.lowest = TRUE
    )
  ) %>% 
  count(tramo, gender) %>% 
  group_by(gender) %>% 
  mutate(prop = n / sum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(x = tramo, y = prop, fill = gender)) +
    geom_col(position = position_dodge(width = 0.8), width = 0.7) +
    geom_text(aes(label = percent(prop, accuracy = 1)),
              position = position_dodge(width = 0.8),
              vjust = -0.5,
              size = 4) +
    scale_y_continuous(
      labels = percent_format(accuracy = 1),
      limits = c(0, 0.4)
    ) +
    labs(
      x     = "Rango de edad (años)", 
      y     = "Porcentaje de compradores",
      fill  = "Sexo"
    ) +
    theme_minimal(base_size = 15) +
    theme(
      axis.text.x      = element_text(size = 12, angle = 45, hjust = 1),
      axis.text.y      = element_text(size = 12),
      axis.title.x     = element_text(size = 14),
      axis.title.y     = element_text(size = 14),
      legend.title     = element_text(size = 13),
      legend.text      = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )


```



## Preferencia  de productos de acuerdo con edad y sexo

Al comparar las distribuciones de edad según la categoría de producto (Figura \@ref(fig:figinf2)), constatamos que todas las curvas de densidad son casi planas y muy parecidas entre los 18 y los 69 años. La Tabla \@ref(tab:tabla-resultado1b) confirma esta homogeneidad: las medianas (Q2) oscilan entre 43 y 44 años, el tercer cuartil (Q3) entre 56 y 57 años —lo que significa que el 75% de los compradores tiene esa edad o menos—, y el coeficiente de variación ronda el 34 % en todas las categorías, señalando una dispersión moderada. No se observan valores atípicos en ningún grupo (Figura \@ref(fig:figinf2)).

Pese a esta uniformidad general, cada categoría muestra leves ondulaciones que podrían apuntar a preferencias etarias muy concretas (ver la  Figura \@ref(fig:figinf4a)):

- Technology: pequeño repunte entre 37 y 40 años.

- Toys: ligero aumento en los rangos 22–24 y 28–30 años.

- Books: discretos “hombros” a 22–25 y 50–53 años.

- Clothing: leves picos a 22–23, 30–32 y 38–40 años.

- Cosmetics: suave repunte en 22–24 años.

- Food & Beverage: mesetas alrededor de 22–25, 40–45 y 53–54 años.

- Shoes: modesta elevación hacia 63–65 años.

- Souvenir: repunte muy leve en 30–32 años.

Aunque son sutilezas, no rompen el patrón: los compradores de todas las categorías comparten un perfil de edad muy homogéneo, sin un rango etario claramente dominante para ningún producto.


```{r figinf2,fig.cap="Distribución de Edad vs. Tipo de producto.", echo=FALSE}


# Boxplot: Edad por Tipo de Producto 
plot_box <- ggplot(datos_mod7, aes(category, age)) +
  geom_boxplot(fill = "#2A91A2", alpha = 0.8) +
  labs(
    x = "Tipo de Producto",
    y = "Edad(años)"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    axis.text.x      = element_text(angle = 45, hjust = 1),
    axis.text.y      = element_text(size = 10),
    axis.title.x     = element_text(size = 10),
    axis.title.y     = element_text(size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

# Densidad: Edad diferenciada por Tipo de Producto 
plot_density <- ggplot(datos_mod7, aes(age, colour = category)) +
  geom_density(linewidth = 1) +
  labs(
    x = "Edad (años)",
    y = "Densidad"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    legend.title      = element_blank(),
    axis.text.y       = element_text(size = 10), 
    axis.title.x     = element_text(size = 10),
    axis.title.y     = element_text(size = 10),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank()
  )

# Disposición vertical (2 filas) 
grid.arrange(plot_box, plot_density, nrow = 2)

```




```{r tabla-resultado1b, eval=TRUE,echo=FALSE}

tabla_edad_categoria <- datos_mod7 %>% 
  group_by(category) %>% 
  summarise(
    Min = min(age, na.rm = TRUE),
    Q1  = quantile(age, 0.25, na.rm = TRUE),
    Q2  = median(age, na.rm = TRUE),
    Q3  = quantile(age, 0.75, na.rm = TRUE),
    Max = max(age, na.rm = TRUE),
    CV  = sd(age, na.rm = TRUE) / mean(age, na.rm = TRUE)
  ) %>% 
  mutate(CV = round(CV, 3))   # redondea el CV a 3 decimales

knitr::kable(
  tabla_edad_categoria,
  booktabs = TRUE,
  caption = "Resumen de Edad (años) por Categoría de producto: el primer cuartil (Q1), 
la mediana (Q2), 
el tercer cuartil (Q3), 
el valor mínimo (Min), 
el valor máximo (Max)  el coeficiente de variación (CV)."
)

```


```{r figinf4a,fig.cap="Distribución de Edad vs. Categoría de producto.", echo=FALSE}

ggplot(datos_mod7, aes(x = age)) +
  geom_density(fill = "#2A91A2", alpha = 0.6) +
  facet_wrap(~ category, scales = "free_y", ncol = 2) +
  labs(
    title = "",
    x     = "Edad (años)",
    y     = "Densidad"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    strip.text       = element_text(size = 12),
    axis.text.x      = element_text(size = 9),
    axis.text.y      = element_text(size = 9),
    axis.title.x     = element_text(size = 14),
    axis.title.y     = element_text(size = 14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

```

De acuerdo con la Figura \@ref(fig:figinf3), en todos los tipos de producto las compradoras superan a los compradores en una proporción que ronda el 60% vs. 40%:

- Books: 58 % mujeres vs. 42% hombres

- Clothing, Cosmetics, Food & Beverage, Souvenir, Technology, Toys: 60% / 40%

- Shoes: 59% / 41%

La muestra de compradores mantiene un perfil de género muy estable, y esto coincide con el hecho de que la muestra analizada, el 60% de las compras las realizaron mujeres, frente a un 40% de hombres. 




```{r figinf3,fig.cap="Distribución de Sexo vs. Tipo de Producto.", echo=FALSE}


# Calcular porcentajes dentro de cada categoría

df_cat_sex <- datos_mod7 %>% 
  count(category, gender) %>%                     # frecuencia por grupo
  group_by(category) %>% 
  mutate(prop = n / sum(n),                       # porcentaje dentro de la categoría
         etiqueta = percent(prop, accuracy = 1))  # etiqueta 60 %, 40 %, etc.


# Gráfico de barras sin cuadrícula, eje Y en %, etiqueta sobre cada barra

ggplot(df_cat_sex, aes(category, prop, fill = gender)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = etiqueta),
            position = position_dodge(width = 0.8),
            vjust = -0.4, size = 3.5) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),         # eje Y en %
    limits = c(0, max(df_cat_sex$prop) * 1.12),    # 12 % de aire arriba
    expand = expansion(mult = c(0, .02))
  ) +
  scale_fill_manual(values = c("#DB735C", "#2A91A2")) +
  labs(
    title = "",
    x     = "Tipo de producto",
    y     = "Porcentaje",
    fill  = "Sexo"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x       = element_text(angle = 45, hjust = 1),
    panel.grid.major  = element_blank(),   # ← sin cuadrícula
    panel.grid.minor  = element_blank()
  )

```


De acuerdo con la Figura \@ref(fig:figinf00aa), en conjunto, no hay variaciones mayores al 1% por producto según la edad ni el sexo: solo en clothing y toys se aprecia la diferencia leve. Esto refleja un perfil de consumidor muy homogéneo, donde la prioridad de categorías —ropa, cosméticos, food & beverage, calzado, juguetes, tecnología, souvenirs— es prácticamente idéntica en mujeres y hombres y en todos los rangos etarios.

```{r figinf00aa,fig.cap="Distribución de categorías por sexo y rango de edad.", echo=FALSE}


# Preparo los datos, calculo proporciones y etiquetas con los nuevos tramos etarios
df_cat_age_sex <- datos_mod7 %>% 
  mutate(
    tramo = cut(
      age,
      breaks = c(18, 25, 35, 45, 55, 65, 69),
      labels = c("Edad 18–24", "Edad 25–34", "Edad 35–44",
                 "Edad 45–54", "Edad 55–64", "Edad 65–69"),
      include.lowest = TRUE
    ),
    gender = factor(gender, 
                    levels = c("female", "male"),
                    labels = c("Femenino", "Masculino"))
  ) %>% 
  count(gender, tramo, category) %>% 
  group_by(gender, tramo) %>% 
  mutate(
    prop     = n / sum(n),
    etiqueta = percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

# Gráfico con etiquetas por encima de la barra
ggplot(df_cat_age_sex, aes(x = category, y = prop, fill = category)) +
  geom_col(width = 0.5, show.legend = FALSE) +
  geom_text(aes(label = etiqueta),
            position = position_stack(vjust = 1),
            vjust    = -0.3,
            size     = 1.8,
            color    = "black") +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.15))
  ) +
  facet_grid(gender ~ tramo, 
             scales = "fixed", 
             space = "fixed", 
             switch = "both") +
  labs(
    x = "Categoría de producto",
    y = "Porcentaje de compradores"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text        = element_text(size = 9),
    axis.text.x       = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y       = element_text(size = 8),
    axis.title.x      = element_text(size = 9),
    axis.title.y      = element_text(size = 9),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank(),
    panel.spacing.x   = unit(0.3, "cm"),
    panel.spacing.y   = unit(0.6, "cm")
  )



```






## Métodos de pago de acuerdo con edad, sexo y tipo de producto



La comparación de los boxplots de la Figura \@ref(fig:figinf4) y los resultados de la Tabla \@ref(tab:tabla-resultado1bbb) revela que la distribución de la edad de los compradores es prácticamente idéntica, sea cual sea el método de pago. En los tres métodos de pago, la mitad de los compradores tiene entre 30 y 56 años, y 50% tienen máximo  43 años, y en todos los casos el rango completo abarca desde los 18 hasta los 69 años. El coeficiente de variación, cercano al 34%, indica una dispersión relativa moderada y muy similar alrededor de la media para cada forma de pago.

Si observamos las curvas de densidad superpuestas, vemos que casi no existe diferencia en la probabilidad de compra a una edad dada: tanto al pagar en efectivo como con crédito o débito, las curvas se solapan entre los 18 y los 69 años. Sólo aparecen ligeras ondulaciones, como un pequeño descenso en el uso de tarjeta de crédito hacia los 28-29 años o un leve repunte del pago en efectivo alrededor de los 63–65 años, pero tales variaciones son tan sutiles que no modifican el patrón general.

En conjunto, estos hallazgos indican que el método de pago no está sesgado hacia ningún tramo etario: compradores de todas las edades utilizan de manera muy similar efectivo, crédito y débito en esta muestra.



```{r figinf4,fig.cap="Distribución de Edad vs. Método de pago.", echo=FALSE}

# Box-plot: Edad por Método de Pago 
plot_box <- ggplot(datos_mod7, aes(payment_method, age)) +
  geom_boxplot(fill = "#2A91A2", alpha = 0.7) +
  labs(title = "",
       x = "Método de pago",
       y = "Edad (años)") +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x       = element_text(size = 14, angle = 45, hjust = 1),
    axis.text.y       = element_text(size = 14),
    axis.title.x      = element_text(size = 16),
    axis.title.y      = element_text(size = 16),
    panel.grid.major  = element_blank(),   # ← sin cuadrícula
    panel.grid.minor  = element_blank()
  )

# Densidad: Edad diferenciada por Método de Pago 
plot_density <- ggplot(datos_mod7, aes(age, colour = payment_method)) +
  geom_density(linewidth = 1.2) +
  labs(title = "",
       x = "Edad (años)",
       y = "Densidad") +
  theme_minimal(base_size = 16) +
  theme(
    axis.text        = element_text(size = 14),
    axis.title.x     = element_text(size = 16),
    axis.title.y     = element_text(size = 16),
    legend.title     = element_blank(),
    legend.text      = element_text(size = 14),
    panel.grid.major = element_blank(),   # ← sin cuadrícula
    panel.grid.minor = element_blank()
  )

# Disposición vertical (2 filas) 
grid.arrange(plot_box, plot_density, ncol = 1)

```


```{r tabla-resultado1bbb, eval=TRUE,echo=FALSE}

tabla_edad_metodo_sexo <- datos_mod7 %>%
  group_by(gender, payment_method) %>%
  summarise(
    Min = min(age, na.rm = TRUE),
    Q1  = quantile(age, 0.25, na.rm = TRUE),
    Q2  = median(age, na.rm = TRUE),
    Q3  = quantile(age, 0.75, na.rm = TRUE),
    Max = max(age, na.rm = TRUE),
    CV  = sd(age, na.rm = TRUE) / mean(age, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    CV = round(CV, 3)
  )

# 2) Mostrar la tabla con knitr::kable
kable(
  tabla_edad_metodo_sexo,
  booktabs = TRUE,
  caption = "Resumen de Edad por Sexo y Método de pago: el primer cuartil (Q1), 
la mediana (Q2), 
el tercer cuartil (Q3), 
el valor mínimo (Min), 
el valor máximo (Max)  el coeficiente de variación (CV)."
)

```



De acuerdo con la Figura \@ref(fig:figinf5), en ambos paneles —mujeres  y hombres— se aprecia un patrón prácticamente idéntico con diferencias porcentuales máximo del 3%. En todos los tipos de producto, el efectivo es con diferencia la forma de pago más habitual (entre un 44% y un 46% de las transacciones), seguido de la tarjeta de crédito (alrededor del 33%–36%) y, por último, la tarjeta de débito (estable en torno al 20–2%).

Estas proporciones se mantienen estables en las ocho categorías: books, clothing, cosmetics, food & beverage, shoes, souvenir, technology y toys. No hay diferencias sustanciales entre mujeres y hombres: ambos sexos utilizan en muy similar medida cada método de pago, sin que ninguna categoría presente sesgos de género significativos. Las ligeras fluctuaciones (p. ej. un 36% de crédito en cosmetics para mujeres frente a un 34% para hombres) son mínimas y no alteran el patrón global.

```{r figinf5,fig.cap="Distribución de Método de pago vs. Tipo de producto vs. Sexo.", echo=FALSE}


# Preparamos los datos con proporciones y etiquetas
df_pay_cat_sex <- datos_mod7 %>% 
  count(gender, category, payment_method) %>% 
  group_by(gender, category) %>% 
  mutate(
    prop     = n / sum(n),
    etiqueta = percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

# Gráfico con paneles por sexo y labeller para traducir los niveles
ggplot(df_pay_cat_sex,
       aes(x = category, y = prop, fill = payment_method)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = etiqueta),
            position = position_dodge(width = 0.8),
            vjust = -0.4, size = 3.5) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    limits = c(0, max(df_pay_cat_sex$prop) * 1.12),
    expand = expansion(mult = c(0, 0.02))
  ) +
  facet_wrap(~ gender, 
             nrow = 2,
             labeller = labeller(gender = c(
               female = "Femenino",
               male   = "Masculino"
             ))) +
  labs(
    x    = "Tipo de producto",
    y    = "Porcentaje dentro de cada categoría",
    fill = "Método de pago"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    # Strips sin negrita
    strip.text       = element_text(face = "plain", size = 9),
    # Ejes y títulos sin negrita
    axis.text.x      = element_text(angle = 45, hjust = 1, size = 12, face = "plain"),
    axis.text.y      = element_text(size = 12, face = "plain"),
    axis.title       = element_text(face = "plain", size = 14),
    axis.title.x     = element_text(margin = margin(t = 8), face = "plain", size = 14),
    axis.title.y     = element_text(margin = margin(r = 8), face = "plain", size = 14),
    # Leyenda sin negrita
    legend.title     = element_text(face = "plain", size = 14),
    legend.text      = element_text(face = "plain", size = 12),
    # Sin cuadrículas
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )



```



En las Figuras \@ref(fig:figinf5aa1) (Femenino) y \@ref(fig:figinf5aa2) (Masculino) se aprecia que, para los tres métodos de pago (efectivo, tarjeta de crédito y débito), la distribución de compras por categoría resulta notablemente homogénea a lo largo de los seis rangos de edad. En ambos sexos, clothing lidera con creces, concentrando habitualmente entre el 34% y el 36% de las transacciones en todos los grupos etarios y formas de pago. Le siguen cosmetics y food & beverage, con porcentajes que oscilan entre el 14% y el 17%. A continuación aparecen shoes (aprox. 9 %–11%) y toys (cercano al 10%), mientras que souvenir y technology cierran el ranking rondando el 5 %.

Las mínimas desviaciones respecto al promedio —por ejemplo, un 33% de clothing en mujeres de 65–69 años pagando con débito, o un 14% de cosmetics en hombres de 35–44 con tarjeta de crédito— no alteran la consistencia del patrón general. En todos los subgrupos, clothing mantiene su dominio cercano al 35%, y las demás categorías conservan proporciones muy similares a las medias globales, lo que evidencia un perfil de consumo estable e independiente de la edad, el sexo o el medio de pago.



```{r figinf5aa1,fig.cap="Preferencia de categoría por tramo de edad por sexo  y método de pago.", echo=FALSE}


# Preparo los datos
df_pref_pm <- datos_mod7 %>%
  mutate(
    tramo = cut(
      age,
      breaks = c(18, 25, 35, 45, 55, 65, 69),
      labels = c("Edad 18–24", "Edad 25–34", "Edad 35–44",
                 "Edad 45–54", "Edad 55–64", "Edad 65–69"),
      include.lowest = TRUE
    ),
    gender = factor(gender,
                    levels = c("female", "male"),
                    labels = c("Femenino", "Masculino"))
  ) %>%
  count(gender, payment_method, tramo, category) %>%
  group_by(gender, payment_method, tramo) %>%
  mutate(
    prop     = n / sum(n),
    etiqueta = percent(prop, accuracy = 1)
  ) %>%
  ungroup()

# Gráfico para Femenino
plot_female <- df_pref_pm %>%
  filter(gender == "Femenino") %>%
  ggplot(aes(x = category, y = prop, fill = category)) +
    geom_col(width = 0.6, show.legend = FALSE) +
    geom_text(aes(label = etiqueta),
              position = position_stack(vjust = 1),
              vjust    = -0.2,
              size     = 1.8,
              color    = "black") +
    facet_grid(payment_method ~ tramo,
               scales = "fixed", space = "fixed", switch = "both") +
    scale_y_continuous(
      labels = percent_format(accuracy = 1),
      expand = expansion(mult = c(0, 0.15))
    ) +
    labs(
      title = "Femenino",
      x     = "Categoría de producto",
      y     = "Porcentaje de compras"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title        = element_text(size = 12, face = "plain"),
      strip.text        = element_text(size = 9),
      axis.text.x       = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y       = element_text(size = 8),
      axis.title.x      = element_text(size = 9),
      axis.title.y      = element_text(size = 9),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      panel.spacing.x   = unit(0.3, "cm"),
      panel.spacing.y   = unit(0.6, "cm")
    )

# Gráfico para Masculino
plot_male <- df_pref_pm %>%
  filter(gender == "Masculino") %>%
  ggplot(aes(x = category, y = prop, fill = category)) +
    geom_col(width = 0.6, show.legend = FALSE) +
    geom_text(aes(label = etiqueta),
              position = position_stack(vjust = 1),
              vjust    = -0.2,
              size     = 1.8,
              color    = "black") +
    facet_grid(payment_method ~ tramo,
               scales = "fixed", space = "fixed", switch = "both") +
    scale_y_continuous(
      labels = percent_format(accuracy = 1),
      expand = expansion(mult = c(0, 0.15))
    ) +
    labs(
      title = "Masculino",
      x     = "Categoría de producto",
      y     = "Porcentaje de compras"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title        = element_text(size = 12, face = "plain"),
      strip.text        = element_text(size = 9),
      axis.text.x       = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y       = element_text(size = 8),
      axis.title.x      = element_text(size = 9),
      axis.title.y      = element_text(size = 9),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      panel.spacing.x   = unit(0.3, "cm"),
      panel.spacing.y   = unit(0.6, "cm")
    )


plot_female



```



```{r figinf5aa2,fig.cap="Preferencia de categoría por tramo de edad por sexo  y método de pago.", echo=FALSE}

 plot_male

```























## Monto total de transacción de acuerdo con edad, sexo y tipo de producto

El monto total facturado por transacción se obtiene multiplicando el precio unitario del artículo por la cantidad vendida. Dado que el precio está expresado en miles de liras, para facilitar la interpretación de las cifras se ha reescalado el importe a unidades de cien mil liras utilizando la fórmula: monto := cantidad * precio / 10.

La comparación de los boxplots de la Figura \@ref(fig:figinf6a) y los resultados de la Tabla \@ref(tab:tabla-resultado1bbb2) revela que en conjunto, hombres y mujeres siguen un patrón casi idéntico de gasto según la categoría de producto. Entre hombres y mujeres las cifras de Q1, Q2, Q3 y Max son casi idénticas para cada categoría, y las diferencias en CV son mínimas (p. ej. CV = 0.786 vs. 0.774 en shoes).

Las categorías de “shoes” y “clothing” concentran los importes más elevados: el 50% de las personas pagaron en calzado más de  540,000 lyras turcas, el 25% cancelaron más de 960,000 y un máximo en torno a 150,000 lyras turcas, mientras que en ropa el 50% de las personas pagaron máximo 12,000 lyras, el 75% superaron el pago de  27,000  y un máximo en 48,000 lyras. En contraste, las demás categorías tienen medianas bajas: libros (~2,400), comida & bebida (~4,700), tecnología (~9,500), souvenirs (~10,600) y cosméticos (~10,630).

El coeficiente de variación (CV) supera en todos los casos el 78%, siendo superior en books para hombres y  en books para mujeres. Esto refleja una gran variabilidad relativa del monto total  respecto a la media por cada grupo y categoría.

No se aprecian diferencias relevantes por sexo en el gasto: los boxplots y las densidades (ver Figura \@ref(fig:figinf6a) y \@ref(fig:figinf6b))  para cada categoría son prácticamente superpuestas y los percentiles (Q1, Q2, Q3) coinciden casi al 100% entre mujeres y hombres. Esto sugiere que, tanto si son hombres o mujeres, el patrón de gasto según el tipo de producto es el mismo: gran inversión en calzado y ropa, y desembolsos menores y más variables en libros, comida‐bebida o cosméticos.



```{r figinf6a,fig.cap="Distribución del Monto total (en 100 miles) por Sexo y Producto.", echo=FALSE}


# Limpieza y recodificación de 'gender'
datos_limpios2 <- datos_mod7 %>% 
  mutate(
    price       = parse_number(
                    as.character(price),
                    locale = locale(decimal_mark = ",", grouping_mark = ".")
                  ),      # “$12.345,67” → 12345.67
    quantity    = parse_number(as.character(quantity)), # “1”, “2”, “3”, etc.
    monto_total = price * quantity / 10,
    category    = factor(category),
    gender      = factor(
                    gender,
                    levels = c("female", "male"),
                    labels = c("Femenino", "Masculino")
                  )
  ) %>% 
  droplevels()

# Boxplot con etiquetas de eje X en español
ggplot(datos_limpios2,
       aes(x = gender, y = monto_total, fill = category)) +
  geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.8) +
  labs(
    x = "Sexo",
    y = "Monto total (en 100 miles)",
    fill = "Categoría"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    axis.text.x      = element_text(angle = 45, hjust = 1, face = "plain"),
    axis.title.x     = element_text(size = 14, face = "plain"),
    axis.title.y     = element_text(size = 14, face = "plain"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )



```





```{r tabla-resultado1bbb2, eval=TRUE,echo=FALSE}

tabla_monto_categoria_sexo <- datos_mod7 %>%
  #Aseguramos que price y quantity sean numéricos  
  mutate(
    price    = as.numeric(as.character(price)),
    quantity = as.numeric(as.character(quantity)),
    monto_total = price * quantity / 10  
  ) %>%
  # Ahora sí resumimos por sexo y categoría
  group_by(gender, category) %>%
  summarise(
    Min = min(monto_total, na.rm = TRUE),
    Q1  = quantile(monto_total, 0.25, na.rm = TRUE),
    Q2  = median(monto_total, na.rm = TRUE),
    Q3  = quantile(monto_total, 0.75, na.rm = TRUE),
    Max = max(monto_total, na.rm = TRUE),
    CV  = sd(monto_total, na.rm = TRUE) / mean(monto_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Redondeamos el CV a tres decimales
  mutate(CV = round(CV, 3))



kable(
  tabla_monto_categoria_sexo,
  booktabs = TRUE,
  caption = "Resumen de monto total (en 100 miles) por sexo y categoría: el primer cuartil (Q1), 
la mediana (Q2), 
el tercer cuartil (Q3), 
el valor mínimo (Min), 
el valor máximo (Max)  el coeficiente de variación (CV)."
)

```



```{r figinf6b,fig.cap="Distribución del Monto total (en unidaes de 100 mil) por Sexo y Producto.", echo=FALSE}


ggplot(datos_limpios2,
                       aes(monto_total, colour = gender)) +
  geom_density(linewidth = 1.2) +
  facet_wrap(~ category,
             scales = "free",
             nrow   = 4,            # ← 4 filas
             ncol   = 2) +          # ← 2 columnas
  labs(x = "Monto total (en 100 milnes)", y = "Densidad") +
  theme_minimal(base_size = 15) +
  theme(
    legend.title      = element_blank(),
    axis.text.x       = element_text(size = 9),
    axis.text.y       = element_text(size = 9),
    axis.title.x      = element_text(size = 14),
    axis.title.y      = element_text(size = 14),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank()
  )



```






## Distribución del consumo en centros comerciales


De acuerdo con la Figura \@ref(fig:figinf7), ropa (clothing) es con diferencia la categoría predominante, con aproximadamente un tercio de las ventas en todos los centros (34–35 %). Le siguen cosméticos y alimentos y bebidas, cada uno con alrededor del 14 – 16 %, sumando entre ambas casi un tercio adicional. Juguetes (toys) y zapatos ocupan un lugar intermedio, aportando entre el 9 – 11 % y el 9 – 10 % respectivamente. Finalmente, categorías como libros, souvenirs y tecnología representan cuotas más pequeñas, entre el 4 – 6 % cada una. 

La homogeneidad de estos porcentajes en todos los centros sugiere que, independientemente de la ubicación, los patrones de compra de los clientes son muy similares: un fuerte sesgo hacia la moda (ropa) seguido por productos de cuidado personal y alimentación, con menor interés en electrónica ligera, libros o recuerdos.


```{r figinf7,fig.cap="Distribución de Tipo de Producto vs. Centro comercial.", echo=FALSE}


#  Tabla de porcentajes 
df_mall_cat <- datos_mod7 %>% 
  count(shopping_mall, category) %>% 
  group_by(shopping_mall) %>% 
  mutate(prop = n / sum(n)) %>% 
  ungroup()

#Barras en porcentaje
ggplot(df_mall_cat,
       aes(shopping_mall, prop, fill = category)) +
  geom_col(
    position = position_dodge(width = 1.2),  # 0.9 → deja hueco entre barras
    width    = 0.4                           # barras más estrechas
  ) +
  geom_text(
    aes(label = percent(prop, accuracy = 1)),
    position = position_dodge(width = 0.9),
    vjust = -0.25,
    size  = 1.6                                # ← etiquetas más pequeñas
  ) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    limits = c(0, max(df_mall_cat$prop) * 1.12),
    expand = expansion(mult = c(0, .02))
  ) +
  labs(
    title = "",
    x     = "Centro comercial",
    y     = "Porcentaje",
    fill  = "Tipo de producto"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x       = element_text(size = 10, angle = 45, hjust = 1),
    axis.text.y       = element_text(size = 10),
    axis.title.x      = element_text(size = 12),
    axis.title.y      = element_text(size = 12),
    legend.title      = element_text(size = 10),
    legend.text       = element_text(size = 10),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank()
  )


```




La Figura \@ref(fig:figinf8) y la Tabla \@ref(tab:tabla-resultadomalls) evidencian que la distribución del monto total por categoría de producto es prácticamente homogénea en todos los centros comerciales: los estadísticos de posición (primer cuartil, mediana y tercer cuartil), los valores extremos (mínimo y máximo) y el coeficiente de variación muestran rangos muy similares entre las distintas ubicaciones. 



```{r figinf8,fig.cap="Distribución de monto total (unidades de 100 mil) por producto y centro comercial.", echo=FALSE}


datos_mod7 <- datos_mod7 %>% 
  mutate(
    price       = as.numeric(price),
    quantity    = as.numeric(quantity),
    monto_total = price * quantity / 10         
  )

ggplot(datos_mod7,
       aes(x = category, y = monto_total / 10, fill = category)) +
  geom_boxplot(alpha = .8, width = .6, outlier.alpha = .3) +
  facet_wrap(~ shopping_mall, nrow = 5, ncol = 2, scales = "free_y") +
  labs(
    x    = "Tipo de producto",
    y    = "Monto total (en 100 miles)",
    fill = "Categoría"        # aquí defines el título de la leyenda
  ) +
  theme_minimal(base_size = 15) +
  theme(
    axis.text.x       = element_text(size = 10, angle = 45, hjust = 1),
    axis.title.x      = element_text(size = 9, face = "plain"),
    axis.title.y      = element_text(size = 9, face = "plain"),
    strip.text        = element_text(size = 7, face = "plain"),
    panel.grid.major  = element_blank(),
    panel.grid.minor  = element_blank()
  )



```





```{r tabla-resultadomalls, eval=TRUE,echo=FALSE}

tabla_monto_malls <- datos_mod7 %>%
  mutate(
    price       = as.numeric(price),
    quantity    = as.numeric(quantity),
    monto_total = price * quantity /10      
  ) %>%
  # Ahora sí resumimos por sexo y categoría
  group_by(category,shopping_mall) %>%
  summarise(
    Min = min(monto_total, na.rm = TRUE),
    Q1  = quantile(monto_total, 0.25, na.rm = TRUE),
    Q2  = median(monto_total, na.rm = TRUE),
    Q3  = quantile(monto_total, 0.75, na.rm = TRUE),
    Max = max(monto_total, na.rm = TRUE),
    CV  = sd(monto_total, na.rm = TRUE) / mean(monto_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Redondeamos el CV a tres decimales
  mutate(CV = round(CV, 3))



kable(
  tabla_monto_malls,
  booktabs = TRUE,
  caption = "Resumen de monto total (en 100 miles) por categoría y centro comercial: el primer cuartil (Q1), 
la mediana (Q2), 
el tercer cuartil (Q3), 
el valor mínimo (Min), 
el valor máximo (Max)  el coeficiente de variación (CV)."
)

```




## Tendencia de consumo por centro comercial en el periodo muestreado

La Figura \@ref(fig:figinf11) presenta la evolución mensual del monto total facturado (en unidades de 100, 000) para los cinco centros comerciales con mayor facturación acumulada, desagregado por categoría de producto. A lo largo del período, ropa y zapatos registran los niveles más elevados de facturación, seguidas por comida, juguete y cosmeticos mientras que libros y tecnología permanecen en rangos considerablemente inferiores. 

Entre los centros, Mall of Istanbul (línea verde) y Kanyon (celeste) se alternan en la posición de liderazgo según la categoría y el período analizado. Metrocity (naranja) ocupa habitualmente el tercer puesto, salvo en la categoría souvenir durante agosto de 2021, cuando momentáneamente escaló a la segunda posición y cuando compartió tercera posición cerca de febrero de 2022.  Metropol AVM (marrón) e Istinye Park (línea oscura) cierran la clasificación, con fluctuaciones más moderadas.

Se aprecia un patrón estacionalen,  la mayoría de las categorías surgen aumentos notorios durante la temporada de verano y, sobre todo, en el último cuarto del año. Tras esos picos, los valores descienden. Por ejemplo, en toys y souvenir los incrementos de noviembre–diciembre se elevan  por encima de la media anual, para caer de nuevo en enero–febrero. El patrón estacional es especialmente evidente en las tres series de mayor facturación, que registran uno o dos picos anuales.



```{r figinf11,fig.cap="Evolución mensual del monto total (unidades de 100 mil) para centros comerciales con mayores facturaciones.", echo=FALSE}

# Calcular monto_total y agregar por mes × mall × categoría

datos_mes <- datos_mod7 %>% 
  mutate(
    fecha_mes   = floor_date(as_date(invoice_date), "month"),
    price_num   = as.numeric(price),
    quantity_num= as.numeric(quantity),
    monto_total = price_num * quantity_num/10
  ) %>% 
  filter(is.finite(monto_total)) %>% 
  group_by(shopping_mall, category, fecha_mes) %>% 
  summarise(monto_mes = sum(monto_total), .groups = "drop")


# Determinar TOP 5 y BOTTOM 5 malls por facturación total

ranking <- datos_mes %>% 
  group_by(shopping_mall) %>% 
  summarise(total_mall = sum(monto_mes), .groups = "drop") %>% 
  arrange(desc(total_mall))

top_malls    <- ranking$shopping_mall[1:5]
bottom_malls <- ranking$shopping_mall[6:10]


# Función para graficar un grupo de malls

plot_monto <- function(df, malls, titulo) {
  
  ggplot(filter(df, shopping_mall %in% malls),
         aes(fecha_mes, monto_mes, colour = shopping_mall, group = shopping_mall)) +
    #geom_line(linewidth = 0.9, alpha = 0.85) +
    geom_smooth(se = FALSE, linewidth = 1, span = 0.5) +
    facet_wrap(~ category, nrow = 4, ncol = 2, scales = "free_y") +
    scale_colour_viridis_d(option = "turbo", name = "Centro comercial") +
    scale_x_date(date_labels = "%Y-%m", date_breaks = "3 months") +
    scale_y_continuous(labels = comma) +
    labs(
      title = titulo,
      x     = "Fecha (mensual)",
      y     = "Monto total mensual"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x       = element_text(angle = 45, hjust = 1, size = 9),
      axis.text.y       = element_text(size = 10),
      axis.title.x      = element_text(size = 16),
      axis.title.y      = element_text(size = 16),
      strip.text        = element_text(face = "bold"),
      legend.title      = element_text(size = 14),
      legend.text       = element_text(size = 12),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank()
    )
}


#  Los 5 de mayores montos

plot_top    <- plot_monto(datos_mes, top_malls,"")

plot_top


```




De acuerdo con la Figura \@ref(fig:figinf12), los centros comerciales Cevahir AVM, Emaar Square Mall, Forum Istanbul, Viaport Outlet y Zorlu Center son los de menor facturación (en unidades de 100 mil). En general, todas estas sedes comparten una estructura de ventas dominada por las categorías de moda: ropa y calzado.

Desde una perspectiva temporal, se observan algunos patrones estacionales a lo largo del período analizado (2021-2023). En casi todos las categorías ciertos meses del año presentan picos de facturación seguidos de descensos pronunciados. Por ejemplo,  en los 5 centros comerciales, hacia finales de año  (2021-11, 2022-11) se registran aumentos notables en las ventas de en cosmeticos y ropa. Mientras que cerca del verano (2021-08 y 2022-08) se registran aumentos para tecnología, juguetes y libros en algunos de estos centros comerciales. A inicios del año siguiente suele evidenciarse una contracción de la facturación de estos productos. 



```{r figinf12,fig.cap="Evolución mensual del monto total (unidades de 10 mil) para centros comerciales con menores facturaciones.", echo=FALSE}


plot_bottom <- plot_monto(datos_mes, bottom_malls,"")

plot_bottom


```




