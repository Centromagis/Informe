---
title: "Descripción"
---




## Análisis univariado

### Sexo


Realizamos un resumen a la variable gender donde podemos observar que la variable tiene 99459 registros.

```{r}
summary(df_sin_suplicados$gender)
```
En la `Figura 1` la grafica de barras muestra la distribución de la variable gender donde se puede interpretar que La mayoría de los clientes son de género femenino (female). Luego, el segundo grupo más grande es masculino (male) Hay una pequeña cantidad de valores nulos (NA).
 
```{r}
# Crear el grafico de barras
ggplot(df_sin_suplicados, aes(x = df_sin_suplicados$gender)) +
  geom_bar(fill = c("lightpink", "lightskyblue", "black"), color = "black") +
  labs(title = "Figura 1. Distribucion de Genero de Clientes", 
       x = "Genero", 
       y = "Frecuencia") +
  theme_minimal()
```

a continuacion un conteo de valores para un total de registros (NA).

```{r}
# Crear tabla con los conteos
gender_counts <- data.frame(
  Gender = c("female", "male", "NA"),
  Count = c(sum(df_sin_suplicados$gender == "female", na.rm = TRUE),
            sum(df_sin_suplicados$gender == "male", na.rm = TRUE),
            sum(is.na(df_sin_suplicados$gender)))
)

# Mostrar la tabla
print(gender_counts)
```


### Edad

Realizamos un resumen a la variable age.

```{r}
summary(df_sin_suplicados$age)

```

Al analizar la variable edad, observamos que la mediana (43 años) y la media (43.43 años) son bastante cercanas, lo que indica una distribución aproximadamente simétrica y sin una fuerte influencia de valores extremos. El rango de edades va de 18 a 69 años, con un rango intercuartílico (IQR) entre 30 y 56 años, lo que sugiere que la mayoría de los datos se concentran en la adultez media. Además, se identifican 19 valores faltantes (NA),


A continuacion se realiza un diagrama de caja como se ve en la `Figura 2`.
```{r}
# Boxplot para detectar valores atipicos
ggplot(df_sin_suplicados, aes(y = age)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Figura 2. Valores Atipicos en Edad", y = "Edad")

```

Al analizar el diagrama, la línea dentro de la caja representa la mediana, que parece estar alrededor de los 40-45 años. El mínimo y el máximo están representados por las líneas negras que salen de la caja, indicando que la edad mínima está en 18 años y la máxima alrededor de 69 años. No se observan puntos fuera de los "bigotes" del boxplot, lo que sugiere que no hay edades extremadamente fuera del rango esperado. Si existieran valores atípicos, se verían como puntos individuales fuera de los límites de los bigotes.

A continuación en la " `Figura 3` se muestra la gráfica de distribución de edad de clientes.

```{r}
# Crear el grafico de barras
ggplot(df_sin_suplicados, aes(x = df_sin_suplicados$age)) +
  geom_histogram(binwidth = 1, fill = "lightgreen", color = "black") +
  labs(title = "Figura 3. Distribucion de Edad de Clientes", 
       x = "Edad", 
       y = "Frecuencia") +
  theme_minimal()
```

La frecuencia de las edades es relativamente homogénea en todo el rango (18-69 años), lo que refuerza la cercanía entre la media y la mediana observada en el diagrama de caja. Además, la ausencia de valores extremos es consistente con la forma del histograma, donde no se observan colas largas ni acumulaciones en los extremos. Esto sugiere que la distribución de la variable edad es simétrica y no presenta un sesgo significativo, como también lo indica el resumen estadístico la media y la mediana.

el numero de valores nulos para esta variable es
```{r}
sum(is.na(df_sin_suplicados$gender))
```


### Categoría

Realizamos un resumen a la variable gender donde podemos observar que la variable tiene 99459 registros.

```{r}
summary(df_sin_suplicados$category)

```

A continuaciónen la " `Figura 4` se muestra la gráfica de frecuencias de category de clientes

```{r}
# Crear el grafico de barras para la variable 'category'
ggplot(df_sin_suplicados, aes(x = df_sin_suplicados$category)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Figura 4. Distribucion de Categorias de Producto", 
       x = "Categoria de Producto", 
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Mejorar la legibilidad de las categorias
```

La grafica muestra que la categoría de clothing es la mas comprada, con 34486 registros, mientras que cosmetics 15096 y food & beverage 14775 tienen frecuencias similares. Shoes también tiene una presencia considerable con 10032 registros. Las categorías souvenir 4999 y technology 4995 son las menos frecuentes, junto con books 4980. Toys se encuentra en un punto intermedio con 10087 registros. También se observa una pequeña cantidad de valores faltantes NA = 9. La distribución indica una alta concentración en clothing.

Tabla de conteo de valores para un total de registros (NA)
```{r}
# Crear tabla de frecuencias 
table_category <- as.data.frame(table(df_sin_suplicados$category, useNA = "ifany"))
colnames(table_category) <- c("Categoria", "Frecuencia")
print(table_category)
```


### Cantidad

Visualizamos el resumen de la variable quantity 
```{r}
summary(df_sin_suplicados$quantity)
```
La variable quantity representa la cantidad de productos comprados. Sus valores oscilan entre 1 y 5, con una mediana de 3 y una media de 3.003, lo que indica una distribución equilibrada. El 25% de las transacciones incluyen 2 o menos productos, mientras que el 75% incluyen 4 o menos. los cuartiles están dentro del rango observado, no hay valores atípicos NA en esta variable.



A continuación en la " `Figura 5` se muestra la gráfica de caja para la variable cantidad.

```{r}
ggplot(df_sin_suplicados, aes(y = quantity)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Figura 5. Valores Atipicos en Cantidad", y = "Cantidad")
```

Dado que el máximo es 5 y el mínimo es 1, y los cuartiles están dentro de este rango, parece que no hay valores atípicos y lo podemos confirmar con la gráfica boxplot ya que no hay puntos fuera de los "bigotes" del boxplot.

### Precio

Visualizamos el resumen de la variable price

```{r}
summary(df_sin_suplicados$price)
```

La variable price representa el precio unitario de los productos en liras turcas (TL). Su distribución muestra una gran dispersión, con un mínimo de 1 TL y un máximo de 7.575.000 TL, lo que sugiere la presencia de valores extremos. La media es mucho mayor que la mediana, y el máximo es muy superior al tercer cuartil, los datos están sesgados hacia la derecha y hay 22 registros con NA.


A continuacion la `Figura 6` muestra la grafica de caja para la variable price 

```{r}
ggplot(df_sin_suplicados, aes(y = price)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Figura 6. Valores Atipicos en Precio", y = "Precio (TL)")
```
El diagrama de caja confirma la presencia de valores atípicos en la variable price. Se pueden observar varios puntos fuera de los bigotes del boxplot, lo que indica que existen precios significativamente mayores al resto de los datos.

Adicional realizamos un gráfico de dispersión de precios por categoría y observamos valores atípicos como se muestra en la `Figura 7`.
```{r}
ggplot(df_sin_suplicados, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Figura 7. Dispersion de Precios por Categoria", x = "Categoria", y = "Precio (TL)")
```

Se observa que la mayoría de los precios están concentrados en valores bajos, pero hay algunos valores atípicos bastante elevados en varias categorías.

### Método de pago

Realizamos un resumen a la variable gender donde podemos observar que la variable tiene 99459 registros
```{r}
summary(df_sin_suplicados$category)
```
A continuación se muestra la gráfica de frecuencias de payment_method de clientes como se muestra en la `Figura 8`

```{r}
ggplot(df_sin_suplicados, aes(x = df_sin_suplicados$payment_method)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Figura 8. Distribucion de payment_method de Producto", 
       x = "medio de pago de Producto", 
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

La grafica confirma que cash es el método de pago mas utilizado, con 44447 transacciones, seguido de credit card con 34926 y debit card con 20078. Los valores faltantes (NA) son mínimos, con solo 8 registros.

```{r}
# Crear tabla de frecuencias 
table_payment_method <- as.data.frame(table(df_sin_suplicados$payment_method, useNA = "ifany"))
colnames(table_payment_method) <- c("Categoria", "Frecuencia")
print(table_payment_method)
```



### Fecha de transacción

```{r}
head(df_sin_suplicados$invoice_date)
```


```{r}
df_sin_suplicados <- df_sin_suplicados %>%
  mutate(invoice_date = as.Date(invoice_date)) 
```

Visualizamos el resumen de la variable price 
```{r}
summary(df_sin_suplicados$invoice_date)
```

Las transacciones se registran desde el 1 de enero de 2021 hasta el 8 de marzo de 2023. La mediana indica que el 50% de las compras ocurrieron antes del 5 de febrero de 2022. La distribución es estable entre 2021 y 2022, pero hay una caída notable en 2023, lo que sugiere una disminución en las transacciones

Revisamos como se almacenan los datos en invoice_date:
```{r}
str(df_sin_suplicados$invoice_date)
```

se revisa si hay valores NA:

```{r}

sum(is.na(df_sin_suplicados$invoice_date)) 
```

Validacion de fechas fuera de rango

```{r}
valid_dates <- df_sin_suplicados$invoice_date <= as.Date("1960-01-01") & df_sin_suplicados$invoice_date >= as.Date("2025-02-08")

sum(valid_dates)  # Cuantas fechas estan fuera del rango
df_sin_suplicados[valid_dates, ] 
```

A continuacion se muestra la grafica de frecuencias de payment_method de clientes como se muestra en la `Figura 9`
```{r}

df_sin_suplicados %>%
  mutate(invoice_quarter = floor_date(invoice_date, "quarter")) %>%
  count(invoice_quarter) %>%
  ggplot(aes(x = invoice_quarter, y = n)) +
  geom_col(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(title = "Figura 9. Distribucion de Fechas (Agrupado por Trimestre)", x = "Fecha", y = "Frecuencia")
```

La grafica muestra la distribucion de transacciones agrupadas por trimestre. Se observa una frecuencia relativamente estable entre 2021 y 2022, con un leve aumento en algunos periodos. Sin embargo, en 2023 hay una caida notable, lo que podria indicar una disminucion en las transacciones

### Centro comercial

Realizamos un resumen a la variable shopping_mall donde podemos observar que la variable tiene 99459 registros

```{r}
summary(df_sin_suplicados$shopping_mall)
```

A continuacion la grafica de Distribucion de shopping_mall por Producto como se muestra en la `Figura 10`

```{r}
ggplot(df_sin_suplicados, aes(x = df_sin_suplicados$shopping_mall)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Figura 10. Distribucion de shopping_mall por Producto", 
       x = "centro comercial", 
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

La mayoria de transacciones ocurren en Kanyon y Mall of Istanbul, seguidos por Metrocity, Istinye Park y Metropol AVM. Los centros con menos actividad son Cevahir AVM, Emaar Square Mall, Forum Istanbul, Viaport Outlet y Zorlu Center. Los valores NA son insignificantes.

```{r}
# Crear tabla de frecuencias 
table_payment_method <- as.data.frame(table(df_sin_suplicados$shopping_mall, useNA = "ifany"))
colnames(table_payment_method) <- c("Categoria", "Frecuencia")
print(table_payment_method)
```




---

## Análisis bivariado










### Tabla atipicos o inconsistencias

En la `tabla 2` podemos observar la estadistica y registroas faltantes para cada variable.

```{r}

df_sin_suplicados %>%
  skim() %>%
  as_tibble() %>%
  mutate(IQR = numeric.p75 - numeric.p25) %>%
  select(skim_variable, numeric.mean, numeric.sd, IQR, numeric.p0, numeric.p25, numeric.p50, numeric.p75, numeric.p100, n_missing, complete_rate) %>%
  kable( caption = 'tabla 2. Tanla atipicos o inconsistencias')  # Genera una tabla mas bonita en HTML
```
Finalmente se detecta valores atipicos o inconsistencias


## Paso 4: Manejo de valores atipicos

De auerdo a las graficas anteriores podemos observar datos atipicos en la variable price para ello inicialmente, el boxplot muestra varios puntos fuera de los "bigotes", lo que indica la presencia de valores extremos en la variable price. Algunos precios son extremadamente altos, del orden de millones de liras turcas, lo que podria deberse a errores en los datos, como unidades mal ingresadas. Para determinar que precios son anormalmente altos, calculamos los limites del rango intercuartilico (IQR):
```{r}
Q1 <- quantile(df_sin_suplicados$price, 0.25, na.rm = TRUE)
Q3 <- quantile(df_sin_suplicados$price, 0.75, na.rm = TRUE)
IQR_value <- Q3 - Q1
```

Limite infeior: 
```{r}
infeior <- Q1 - 1.5 * IQR_value  # Limite inferior 
infeior
```

arroja un resultado negativo en este caso porque los precios no pueden ser negativos. Esto significa que no hay valores atipicos en la parte baja de la distribucion.

Limite superior: 
```{r}
#limites para valores atipicos
superior <- Q3 + 1.5 * IQR_value  # Limite superior
superior
```

Cualquier precio mayor a 146117.5 se considera un valor atipico alto.

```{r}
# Ver cuantos valores estan fuera del limite superior
df_sin_atipicos1 <- df_sin_suplicados %>% filter(price >= infeior & price <= superior | is.na(price))
nrow(df_sin_atipicos1)  # Cantidad de valores atipicos

```

A continuacion el diagrama de cajas para la variable price luego de aplicar rango intercuartilico (IQR) como se muestra en la `Figura 11`.

```{r}
ggplot(df_sin_atipicos1, aes(y = price)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Figura 11. data set sin valores atipicos IQR.", y = "Precio (TL)")
nrow(df_sin_atipicos1)
```

La grafica confirma que se eliminaron los valores atipicos y ahora la distribucion es mas compacta, el precio sigue mostrando cierta dispersion, sin embargo al realizar el conteo de valores eliminados es un porcentaje considerable

```{r}
atipicos1 <- df_sin_suplicados %>% filter(price >= superior)
nrow(atipicos1)  # Cantidad de valores atipicos

porcentaje_eliminado = (nrow(atipicos1)  * 100 )/ nrow(df_sin_suplicados)
porcentaje_eliminado
```
Se aplico el metodo del rango intercuartilico (IQR) para identificar y eliminar valores atipicos en la variable Precio. Como resultado, se eliminaron 6046 registros, lo que equivale al 6.078% del conjunto de datos original. Para optimizar la conservacion de la informacion sin comprometer la calidad del analisis, se identificaron los percentiles 1 y 99, permitiendo retener el 99% de los datos y eliminar únicamente el 1% de los valores extremos. Esta estrategia ayuda a reducir el sesgo generado por valores atipicos elevados, los cuales podrian distorsionar la media y afectar la interpretacion de los datos.

```{r}
# Calcular percentil 99

p99 <- quantile(df_sin_suplicados$price, 0.99, na.rm = TRUE)
p99
# Calcular percentil 1
p1 <- quantile(df_sin_suplicados$price, 0.01, na.rm = TRUE)
p1
# Filtrar valores por encima del percentil 99
DS_filtrado <- df_sin_suplicados %>% filter((price >= p1 & price <= p99) | is.na(price))

# Comparar cuantos datos se eliminarian
nrow(df_sin_suplicados) - nrow(DS_filtrado)

```

A continuacion el diagrama de cajas para la variable price luego de aplicar p99 y p1 como se muestra en la `Figura 13`.

```{r}
ggplot(DS_filtrado, aes(y = price)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Figura 13. Valores Atipicos en Precio con p99 y p1", y = "Precio (TL)")

```

Inicialmente, el boxplot muestra varios puntos fuera de los "bigotes", lo que indica la presencia de valores extremos en la variable price. Algunos precios son extremadamente altos, del orden de millones de liras turcas, lo que podria deberse a errores en los datos, como unidades mal ingresadas. realizamos un sumary para cada dataset

```{r}
summary(DS_filtrado$price)
```
Este indica un valor de 300085 para la categoria choes este valor es considerado normal para esta categoria.

```{r}
summary(df_sin_atipicos1$price)
```

Se considera que el IQR elimina gran porcentaje de informacion, el filtrado por percentiles 1 y 99 es una mejor opcion ya que solo eliminar los casos mas extremos. se realiza grafico de dispersion de precios por categoria aplicando ambos metodos como se muestra en la `Figura 14`.

```{r}
p11 <- ggplot(df_sin_atipicos1, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Figura 14. Metodo IQR", x = "Categoria", y = "Precio (TL)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p22 <- ggplot(DS_filtrado, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Metodo Percentil 99 y 1", x = "Categoria", y = "Precio (TL)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p33 <- ggplot(df_sin_suplicados, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Sin eliminar atipicos", x = "Categoria", y = "Precio (TL)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(p11, p22, ncol = 2)
```

En ambas graficas, la mayoria de los datos estan concentrados en valores mas bajos. Sin embargo, en la grafica del metodo percentil, se observan mas valores extremos dispersos en la parte superior, lo que indica que este metodo conserva precios mas altos que el metodo IQR, el cual elimina una mayor cantidad de valores atipicos por lo cual se usara el metodo percentil para la eliminacion de atipicos.

a continuacion se puede visualizar la informacion eliminada con la estrategia del percentil 99 y 1

```{r}
summary(df_sin_suplicados$price)
```

### Datos atipicos

```{r}
p99
p1
at <- df_sin_suplicados %>% filter( price < p1 | price > p99)
at
```
Se eliminaron los valores atípicos de la variable price que son alejados de la realidad, además el precio máximo parece un error de digitación que equivale a 7575000. 

```{r}
df_sin_suplicados %>%
  filter(category == "books") %>%
  count(price, sort = TRUE)
```
A continuacion el diagrama de Caja de Precios - Categoría Libros como se muestra en la `Figura 15` donde solo se puede observar un libro por valor de 7575000 en comparacion a los demas es atipico.
 
```{r}
# Datos de la tabla
price_data <- data.frame(
  price = c(1028, 1007, 1000, 984, 959, 1, 1),
  n = c(7575, 303, 4545, 1515, 606, 7575000, NA)
)

# Eliminar valores NA y encontrar el valor máximo
price_data_clean <- price_data[!is.na(price_data$price), ]
max_price <- max(price_data_clean$price)

# Crear una nueva columna con el valor de cada precio respecto al máximo
price_data_clean$price_ratio <- price_data_clean$price / max_price

# Gráfico
ggplot(price_data_clean, aes(x = factor(n), y = price_ratio)) +
  geom_bar(stat = "identity") +
  labs(x = "Libro", y = "Precio en relacion con el maximo", title = "Figura 15. Comparacion de precios de libros") +
  theme_minimal()
```

Si bien se consideró la posibilidad de imputar estos valores utilizando la media, la mediana e price, el reducido número de datos eliminados sugiere que su exclusión no afecta significativamente el análisis. Por lo tanto, se optó por eliminarlos para garantizar la coherencia del conjunto de datos.

### tabla comparativa con los datos antes y después del tratamiento. 

En la `tabla 3` se muestra los datos antes y después del tratamiento.
```{r}
DataSet_Original <- df_sin_suplicados

DataSet_sin_outliers <- DS_filtrado


# Función para obtener estadísticas resumidas
obtener_estadisticas <- function(df, nombre_df) {
  df %>%
    skim() %>%
    as_tibble() %>%
    mutate(IQR = numeric.p75 - numeric.p25,
           dataset = nombre_df) %>%  # Agregar nombre del dataset
    select(dataset, skim_variable, numeric.mean, numeric.sd, IQR, 
           numeric.p0, numeric.p25, numeric.p50, numeric.p75, numeric.p100, 
           n_missing, complete_rate)
}

# Obtener estadísticas de ambos datasets
stats_df1 <- obtener_estadisticas(DataSet_Original, "DataSet_Original")
stats_df2 <- obtener_estadisticas(DataSet_sin_outliers, "DataSet_sin_outliers")

# Unir en una sola tabla comparativa
tabla_comparativa <- bind_rows(stats_df1, stats_df2)

# Mostrar en formato tabla
kable(tabla_comparativa, caption = 'tabla 3. tabla comparativa con los datos antes y despues del tratamiento')
```

### Incluir graficos que ilustren el impacto de las decisiones tomadas, 

se realizan graficas de las decisiones tomadas para la variable price la cual presento outliers como se muestra en la `Figura 16`.
```{r}
p22 <- ggplot(DS_filtrado, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Figura 16. Metodo Percentil 99 y 1", x = "Categoria", y = "Precio (TL)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p33 <- ggplot(df_sin_suplicados, aes(x = category, y = price)) +
  geom_jitter(alpha = 0.5, color = "black") +
  labs(title = "Sin eliminar atipicos", x = "Categoria", y = "Precio (TL)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(p22, p33, ncol = 2)
```

```{r}
p44 <- ggplot(DS_filtrado, aes(y = price)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Figura 17. Metodo Percentil 99 y 1", y = "Precio (TL)")

p55 <- ggplot(df_sin_suplicados, aes(y = price)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Sin eliminar atipicos", y = "Precio (TL)")
grid.arrange(p44, p55, ncol = 2)
```
La eliminación de valores atípicos mediante percentiles 1 y 99 ayuda a reducir la distorsión y permite una mejor visualización de la distribución central de los precios se consideran aun valores atípicos pero necesarios que muestra la realidad de los precios y los hábitos de consumo en Estambul como se muestra en el diagrama de cajas de la `Figura 17`.


Realizamos una grafica de caja para categoria por precio para identificar que productos estan con precios altos y encontramos que que la categoria es shoes como se muestra en la `Figura 17.1`.  

```{r}
ggplot(DS_filtrado, aes(x = category, y = price,fill = category)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, outlier.size = 2) +
  labs(title = "Figura 17.1 Distribución del Precio por Categoría",
       x = "category",
       y = "price") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Se calcula el precio maximo

```{r}

max_shoes_price <- DS_filtrado %>%
  filter(category == "shoes") %>%
  summarise(max_price = max(price, na.rm = TRUE))

print(max_shoes_price)
```
este valor de 300085 es un precio normal en las marcas Christian Louboutin, Jimmy Choo, Gucci, Louis Vuitton, Berluti,
Santoni en centros comerciales para zapatos de lujo en Estambul. como por ejemplo en

https://lascalientesdelsur.com/entretenimiento/117100/top-10-de-los-zapatos-para-hombres-mas-caros-del-mundo.html?utm_source=chatgpt.com

https://www.farfetch.com/co/shopping/women/gucci/shoes-1/items.aspx?sort=4&category=136310

es por esta razon adicional que no se descartan como atipicos.

## Paso 5: Análisis de datos faltantes

A continuacion la grafica de valores faltantes como se muestra en la `Figura 18` 

```{r}
rotacionNA <- DataSet_sin_outliers # selecciona una muestra de tamaño 1000
datosNA <- rotacionNA   # copia el contenido a datosNA

# Calcula la media de la variable "Edad"

VIM::aggr(datosNA, cex.axis = 0.8, cex.lab = 1.2 ,main = "Analisis de Datos Faltantes")
title(main = "Figura 18. Analisis de Datos Faltantes", col.main = "black", font.main = 2, line = 3)

```
La gráfica muestra la proporción de valores ausentes en cada variable, destacando que las variables con mayor cantidad de datos faltantes son price, gender, age, y invoice_date. Además, variables como category y quantity también presentan valores ausentes, aunque en menor proporción.


A continucacion la grafica de valores faltatntes como se muestra en la `Figura 19`.

```{r}
# Reemplaza los valores faltantes con la media
naniar::gg_miss_var(datosNA) +
  ggtitle("Figura 19. Analisis de Datos Faltantes") +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
```

La gráfica representa la cantidad absoluta de valores faltantes por variable, confirmando que prime, gender y age son las más afectadas, con alrededor de 20 valores ausentes, seguidas de shopping_mall y category.

```{r}
# Calcular el porcentaje de datos faltantes por variable
missing_percent <- colSums(is.na(DataSet_sin_outliers)) / nrow(DataSet_sin_outliers) * 100

# Crear un data frame con los resultados
missing_table <- data.frame(Variable = names(missing_percent),
                            Porcentaje_Faltante = missing_percent)

# Mostrar la tabla
print(missing_table)
```

De acuerdo con la tabla, la variable 'price' presenta el mayor porcentaje de datos faltantes, mientras que 'payment_method' es la variable con menos datos ausentes. Sin embargo, el número de valores faltantes no es significativo en relación con el tamaño del dataset.

## Paso 6: Test de hipótesis para datos faltantes

•	Implementar un test de hipótesis para determinar si el mecanismo de generación de datos faltantes es MCAR (Missing Completely at Random). 
```{r}
resultado <- mcar_test(DataSet_sin_outliers)

# Mostrar los resultados
print(resultado)

# Interpretación
if (resultado$p.value > 0.05) {
  cat("No se rechaza la hipotesis nula: los datos faltantes son MCAR.\n")
} else {
  cat("Se rechaza la hipotesis nula: los datos faltantes no son MCAR.\n")
}
```
Se aplicó el test MCAR (mcar_test) para evaluar el mecanismo de generación de datos faltantes. El resultado arrojó un estadístico de prueba de 49.6 con 62 grados de libertad y un valor p de 0.872. Dado que el valor p es mayor que 0.05, no se rechaza la hipótesis nula, lo que indica que los datos faltantes ocurren completamente al azar y no siguen un patrón sistemático.

## Paso 7: Imputación de datos faltantes.

Recordemos los datos faltantes y dado que el test MCAR no rechazó la hipótesis nula, los datos faltantes pueden considerarse completamente al azar y ya que el número de faltantes en comparación al tamaño del dataset es mínimo se decide imputar los datos.
```{r}
# Reemplaza los valores faltantes con la media
naniar::gg_miss_var(datosNA) # gráfico de datos faltantes
```
### age

El boxplot indica que la distribución de la variable es bastante simétrica, sin una asimetría extrema. La mediana es 43 años, un valor representativo de la tendencia central. Dado que la distribución parece aproximarse a una normal, se opta por imputar los valores faltantes con la mediana como se muestra en la `Figura 20`.

```{r}
ggplot(rotacionNA, aes(y = age)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Figura 20. Diagrama de caja para la variable edad", y = "Edad")
```
```{r}
mediana_Edad <- round(median(datosNA$age, na.rm = TRUE), 2)

mediana_Edad
```
```{r}
datosNA$age[is.na(datosNA$age)] <- mediana_Edad

cat("Media de Edad:", mediana_Edad)

 # gráfico de datos faltantes # gráfico de datos faltantes
```
se imputan los datos faltantes de la variable “age” utilizando el promedio de esta, que es 43.43 años. Este valor se calcula promediando la edad y los valores faltantes (NA) se reemplazan con este promedio.

### category

Los datos faltantes en la variable category representan un número muy pequeño (9 valores) en comparación con el total de registros, por lo que su impacto en el análisis es mínimo. Dado que esta variable es categórica, el método más adecuado para la imputación es la ropa, es decir, la categoría más frecuente. En este caso, la categoría "clothing" tiene la mayor cantidad de observaciones (34484), lo que la convierte en la mejor opción para reemplazar los valores ausentes como se muestra en la `Figura 21`.

```{r}

estado_category <- as.factor(datosNA$category)  # Asegúrate de que sea un factor
datos <- data.frame(category = estado_category)

# Graficar con tema minimalista
plot_estadoc<-ggplot(datos, aes(x = category)) +
  geom_bar(fill = "lightblue", color = "darkblue") +  
  theme_minimal(base_size = 14) +  
  labs(
    title = "Figura 21. frecuencia de transacciones por categoria",
    x = "Categoria",  
    y = "Numero de personas"     
  ) +
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),   
    panel.grid.major = element_blank(),    
    panel.grid.minor = element_blank()    
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(plot_estadoc)

summary(datos)
```
```{r}
moda_Estado_Civil <- Mode(datosNA$category, na.rm = TRUE)
datosNA$category[is.na(datosNA$category)] <- moda_Estado_Civil
# VIM::aggr(datosNA, cex.axis = 0.5, cex.lab= 0.8)
cat("moda Estado_Civil : ", moda_Estado_Civil)
```
### gender

Los datos faltantes en la variable gender representan un número muy pequeño (20  valores) en comparación con el total de registros, por lo que su impacto en el análisis es mínimo. Dado que esta variable es categórica, el método más adecuado para la imputación es la moda, es decir, la categoría más frecuente. En este caso, la categoría "female" tiene la mayor cantidad de observaciones (59468), lo que la convierte en la mejor opción para reemplazar los valores ausentes como s muestra en la `Figura 22`.

```{r}
# Crear el dataframe con la variable Estado_Civil
estado_gender <- as.factor(datosNA$gender)  # Asegúrate de que sea un factor
datos <- data.frame(gender = estado_gender)

# Graficar con tema minimalista
plot_estadoc<-ggplot(datos, aes(x = gender)) +
  geom_bar(fill = "lightblue", color = "darkblue") +  
  theme_minimal(base_size = 14) +  
  labs(
    title = "Figura 22. Valores faltantes en Edad",
    x = "genero",  
    y = "Numero de personas"     
  ) +
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),   
    panel.grid.major = element_blank(),    
    panel.grid.minor = element_blank()    
  )
print(plot_estadoc)

summary(datos)
```

```{r}
moda_gender <- Mode(datosNA$gender, na.rm = TRUE)
datosNA$gender[is.na(datosNA$gender)] <- moda_gender
# VIM::aggr(datosNA, cex.axis = 0.5, cex.lab= 0.8)
cat("moda moda_gender : ", moda_gender)
```

### shopping_mall

Los datos faltantes en la variable shopping_mall representan un número muy pequeño (11 valores) en comparación con el total de registros, por lo que su impacto en el análisis es mínimo. Dado que esta variable es categórica, el método más adecuado para la imputación es la moda, es decir, la categoría más frecuente. En este caso, la categoría "Mall of Istanbul" tiene la mayor cantidad de observaciones (19940), lo que la convierte en la mejor opción para reemplazar los valores ausentes, como se muestra en la `Figura 23`.

```{r}
# Crear el dataframe con la variable Estado_Civil
estado_shopping_mall <- as.factor(datosNA$shopping_mall)  # Asegúrate de que sea un factor
datos <- data.frame(shopping_mall = estado_shopping_mall)

# Graficar con tema minimalista
plot_estadoc<-ggplot(datos, aes(x = shopping_mall)) +
  geom_bar(fill = "lightblue", color = "darkblue") +  
  theme_minimal(base_size = 14) +  
  labs(
    title = "Figura 23. tabla de frecuencia por shopping_mall",
    x = "shopping_mall",  
    y = "Numero de personas"     
  ) +
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),   
    panel.grid.major = element_blank(),    
    panel.grid.minor = element_blank()    
  )+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(plot_estadoc)

summary(datos)
```

```{r}
moda_shopping_mall <- Mode(datosNA$shopping_mall, na.rm = TRUE)
datosNA$shopping_mall[is.na(datosNA$shopping_mall)] <- moda_shopping_mall
# VIM::aggr(datosNA, cex.axis = 0.5, cex.lab= 0.8)
cat("moda moda_shopping_mall : ", moda_shopping_mall)
```
### payment_method

Los datos faltantes en la variable payment_method representan un número muy pequeño (11 valores) en comparación con el total de registros, por lo que su impacto en el análisis es mínimo. Dado que esta variable es categórica, el método más adecuado para la imputación es la moda, es decir, la categoría más frecuente. En este caso, la categoría "Mall of Istanbul" tiene la mayor cantidad de observaciones (19940), lo que la convierte en la mejor opción para reemplazar los valores ausentes, como se muestra en la `Figura 24`.

```{r}
# Crear el dataframe con la variable Estado_Civil
estado_payment_method <- as.factor(datosNA$payment_method)  # Asegúrate de que sea un factor
datos <- data.frame(payment_method = estado_payment_method)

# Graficar con tema minimalista
plot_estadoc<-ggplot(datos, aes(x = payment_method)) +
  geom_bar(fill = "lightblue", color = "darkblue") +  
  theme_minimal(base_size = 14) +  
  labs(
    title = "Figura 24. tabla de frecuencia por payment_method",
    x = "genero",  
    y = "Numero de personas"     
  ) +
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),   
    panel.grid.major = element_blank(),    
    panel.grid.minor = element_blank()    
  )
print(plot_estadoc)

summary(datos)
```
```{r}
# install.packages("DescTools")
library(DescTools)
moda_payment_method <- Mode(datosNA$payment_method, na.rm = TRUE)
datosNA$payment_method[is.na(datosNA$payment_method)] <- moda_payment_method
# VIM::aggr(datosNA, cex.axis = 0.5, cex.lab= 0.8)
cat("moda moda_payment_method : ", moda_payment_method)
```
### price

Dado que el mecanismo de datos faltantes sigue un patrón MCAR y hay 22 valores ausentes, la mejor opción es imputar con la mediana en lugar de la media. La variable price presenta valores atípicos que reflejan la realidad del mercado de libros, y la mediana, al ser más robusta frente a estos extremos, preserva mejor la tendencia central sin distorsionar la distribución. Esto evita sesgos y mantiene la integridad del análisis, como se muestra en la `Figura 25`.

```{r}

# Crear el gráfico de boxplot con líneas en los ejes
boxplot_grafico <- ggplot(datosNA, aes(x = "", y = price)) +
  geom_boxplot(fill = "lightblue", color = "darkblue", outlier.color = "red") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +  
  geom_vline(xintercept = 0.5, linetype = "solid", color = "black") +  
  labs(title = "Figura 25. Diagrama de caja para la variable price") +
  
  theme_minimal(base_size = 14) +
  labs(x = "", y = "price") +
  theme(
    axis.text.x = element_blank(),  
    panel.grid = element_blank()
  )

boxplot_grafico

```

```{r}
# Calcula la mediana de la variable "Años_Experiencia"
mediana_price <- round(median(datosNA$price, na.rm = TRUE),0)
datosNA$price[is.na(datosNA$price)] <- mediana_price
cat("mediana mediana_price : ", mediana_price)
```
```{r}
# Reemplaza los valores faltantes con la media
naniar::gg_miss_var(datosNA)  + 
  ggtitle("Figura 26. Cantidad de valores perdidos por variable") # gráfico de datos faltantes
```
Finalmente, como se muestra en la `Figura 26` el data set esta listo para el análisis.

## Paso 8 - 9: Análisis descriptivo post-procesamiento y Selección de resultados para el informe

Se realiza un resumen al data set limpiado
```{r}
summary(datosNA)
```

#### Cantidad de Productos por Transacción

La variable quantity indica la cantidad de productos adquiridos en cada compra. Se observa un mínimo de 1 unidad y un máximo de 5 unidades por transacción. La media es de 3.003 productos por compra, mientras que el primer cuartil es de 2 unidades y el tercer cuartil de 4 unidades. Esto sugiere que la mayoría de los clientes adquiere entre 2 y 4 productos por transacción.

#### Precio de las Compras

El precio total de las compras, representado por la variable price, varía entre un mínimo de 303 y un máximo de 300085. La media del precio de compra es de 42839, mientras que la mediana es de 12198, lo que sugiere la presencia de valores atípicos que elevan el promedio. El primer cuartil se encuentra en 2615 y el tercer cuartil en 60016, lo que indica una distribución sesgada hacia valores altos.

#### Edad de los Clientes

La variable age representa la edad de los clientes y presenta un rango de valores entre 18 y 69 años. La edad promedio de los compradores es de 43.43 años, con una mediana de 43 años. El primer cuartil se encuentra en 30 años y el tercer cuartil en 56 años, lo que indica que la mayor parte de los clientes tiene edades comprendidas entre estos valores.

```{r}
summary(datosNA)

# Distribución de edades
ggplot(datosNA, aes(x = age)) +
  geom_histogram(binwidth = 5, fill = "lightgoldenrod", color = "black") +
  labs(title = "Distribucion de Edad de los Clientes", x = "Edad", y = "Frecuencia")

ggplot(datosNA, aes(y = age)) +
  geom_boxplot(fill = "#F08080", color = "black") +
  labs(title = "Boxplot de Edad de los Clientes", y = "Edad")

# Distribución de precios
ggplot(datosNA, aes(x = price)) +
  geom_histogram(binwidth = 5000, fill = "lightgreen", color = "black") +
  labs(title = "Distribucion de Precios de los Productos", x = "Precio (TL)", y = "Frecuencia") +
  xlim(0, 150000) # Ajuste de límite para mejor visualización

# Distribución de cantidad comprada
ggplot(datosNA, aes(x = quantity)) +
  geom_histogram(binwidth = 1, fill = "#DDA0DD", color = "black") +
  labs(title = "Distribucion de Cantidad Comprada", x = "Cantidad", y = "Frecuencia")

# Métodos de pago más utilizados
ggplot(datosNA, aes(x = payment_method)) +
  geom_bar(fill = "#FFA07A", color = "black") +
  labs(title = "Frecuencia de Metodos de Pago", x = "Metodo de Pago", y = "Cantidad de Transacciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Ventas por centro comercial
ggplot(datosNA, aes(x = shopping_mall)) +
  geom_bar(fill = "#B0D9E6", color = "black") +
  labs(title = "Ventas por Centro Comercial", x = "Centro Comercial", y = "Cantidad de Transacciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
# Distribución de edades
ggplot(datosNA, aes(x = age)) +
  geom_histogram(binwidth = 5, fill = "lightgreen", color = "black") +
  labs(title = "Distribucion de Edad de los Clientes", x = "Edad", y = "Frecuencia")

# Boxplot de precios (para detectar outliers)
ggplot(datosNA, aes(y = price)) +
  geom_boxplot(fill = "#F08080", color = "black") +
  labs(title = "Distribucion de Precios de los Productos", y = "Precio (TL)")

# Evolución de compras a lo largo del tiempo
datosNA %>%
  mutate(invoice_date = as.Date(invoice_date)) %>%
  group_by(invoice_date) %>%
  summarise(total_ventas = n()) %>%
  ggplot(aes(x = invoice_date, y = total_ventas)) +
  geom_line(color = "#DDA0DD") +
  labs(title = "Tendencia de Ventas en el Tiempo", x = "Fecha", y = "Cantidad de Transacciones")

# Método de pago más usado
ggplot(datosNA, aes(x = payment_method)) +
  geom_bar(fill = "#FFA07A", color = "black") +
  labs(title = "Frecuencia de Metodos de Pago", x = "Metodo de Pago", y = "Cantidad de Transacciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Ventas por centro comercial
ggplot(datosNA, aes(x = shopping_mall)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Ventas por Centro Comercial", x = "Centro Comercial", y = "Cantidad de Transacciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Paso 10: Explicación de patrones y tendencias

Análisis Final sobre los Patrones y Tendencias de Consumo en Estambul

El presente análisis tiene como objetivo identificar los principales patrones y tendencias de consumo en Estambul a partir de los datos procesados. Se analizan factores como la demografía de los consumidores, categorías de productos preferidos, métodos de pago más utilizados y distribución del consumo en los distintos centros comerciales de la ciudad.

### Distribución Demográfica de los Consumidores

Los datos revelan que la mayoría de los clientes se encuentra en el rango de edad de 20 a 60 años, con una distribución relativamente uniforme en los diferentes segmentos de edad. Sin embargo, se observa una disminución significativa en la frecuencia de compras a partir de los 65 años, lo que indica una menor participación de adultos mayores en el consumo, como se muestra en la `Figura 27`.

```{r}

# Distribución de edades
ggplot(datosNA, aes(x = age)) +
  geom_histogram(binwidth = 5, fill = "lightblue", color = "black") +
  labs(title = "Figura 27. Distribucion de Edad de los Clientes", x = "Edad", y = "Frecuencia")
```

### Categorías de Productos Preferidos

Los productos más adquiridos corresponden a las categorías de ropa, cosmeticos y alimentos como lo muestra la `Figura 28`. En la categoría de ropa, se observa una alta demanda en el segmento de 31 a 50 años (39809 unidades), seguida de cerca por el grupo de 51 a 70 años (37685 unidades). Este segmento parece ser el principal consumidor de productos de ropa, lo que hace sugerir que campañas publicitarias dirigidas a adultos de mediana edad podrían ser muy efectivas en este caso.

En el caso de alimentos y bebidas, se destaca el grupo de 31 a 50 años con 17219 unidades, seguido de los consumidores de 51 a 70 años, con 16003 unidades. Esto muestra que los productos alimenticios también son populares en un rango de edad más amplio, pero el grupo de 31 a 50 años sigue dominando las compras.

Por otro lado, la categoría de tecnología presenta una demanda notablemente más baja en comparación con moda y alimentos, pero el grupo de 31 a 50 años también lidera con 5928 unidades, seguido por el grupo de 51 a 70 años (5410 unidades).

Por último, la categoría de libros tiene una demanda bastante equilibrada entre los rangos de edad, con 5700 unidades para los 31-50 años y 5442 unidades para los 51-70 años, lo que sugiere que los libros atraen a un público diverso en cuanto a edades.


```{r}

# Crear una nueva columna para segmentar las edades en varios rangos
data <- datosNA %>%
  mutate(age = case_when(
    age >= 18 & age <= 30 ~ "18-30 year",
    age >= 31 & age <= 50 ~ "31-50 year",
    age >= 51 & age <= 70 ~ "51-70 year",
    age > 70 ~ "71+ year",
    TRUE ~ "Otro"
  ))

# Resumir los datos por categoría y grupo de edad
resumen_categoria <- data %>%
  group_by(category, age) %>%
  summarise(total_quantity = sum(quantity), .groups = "drop")

# Ver el resumen de las categorías por grupo de edad
print(resumen_categoria)

# Crear un gráfico apilado para visualizar la demanda por categoría y grupo de edad
ggplot(resumen_categoria, aes(x = category, y = total_quantity, fill = age)) +
  geom_bar(stat = "identity") +
  labs(title = "Figura 28. Demanda por Categoria y grupo de edad",
       x = "Categoria",
       y = "Cantidad total de productos vendidos") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3")
```
```{r}
#table(datosNA$age)
```


### Métodos de Pago Más Utilizados

El análisis de los métodos de pago indica una preferencia por el pago en efectivo como lo muestra la `Figura 30`, seguido de pagos con tarjeta de credito y debito. Las mujeres (rosa) realizan más transacciones que los hombres (azul) en todos los métodos de pago. La diferencia entre géneros es más notoria en efectivo y tarjeta de credito.


```{r}
# Método de pago más usado
ggplot(datosNA, aes(x = payment_method, fill = gender)) +
  geom_bar(position = "stack", color = "black") +
  labs(title = "Figura 30. Frecuencia de Metodos de Pago por Genero", 
       x = "Metodo de Pago", 
       y = "Cantidad de Transacciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("lightpink", "lightblue")) 
```

la `Figura 31` muestra los diferentes métodos de pago en función del género, utilizando la gráfica de radar presentada y la `Figura 31.1` muestra diferentes metodos de pago por rango de edades . La información se basa en tres categorías principales de pago: efectivo, tarjeta de crédito y tarjeta de débito, con diferenciación entre usuarios masculinos y femeninos.

Existen diferencias en las preferencias de pago entre hombres y mujeres:

Efectivo: Se observa que las mujeres tienen una mayor tendencia a utilizar efectivo en comparación con los hombres. La línea roja (representando a las mujeres ver `Figura 31`) alcanza valores más altos en esta categoría en comparación con la línea azul (hombres).

Tarjeta de crédito: Ambos géneros presentan un uso relativamente similar de las tarjetas de crédito, aunque se percibe una ligera preferencia femenina.

Tarjeta de débito: Los hombres parecen tener un mayor uso de tarjetas de débito en comparació
arjeta de débito: Los hombres parecen tener un mayor uso de tarjetas de débito en comparación con las mujeres, aunque la diferencia no es tan pronunciada.

de acuerdo a la grafica de la figura `Figura 31` las mujeres tienden a depender más del efectivo, mientras que los hombres muestran una inclinación ligeramente mayor hacia las tarjetas de débito. La similitud en el uso de tarjetas de crédito sugiere que este método de pago es aceptado de manera equitativa por ambos géneros.

Estos hallazgos pueden ser útiles para empresas y entidades financieras interesadas en adaptar sus estrategias de pago según las preferencias de cada segmento de la población.

```{r}

# Contar las transacciones por género y método de pago
summary_data <- datosNA %>%
  group_by(gender, payment_method) %>%
  summarise(count = n(), .groups = "drop") %>%
  tidyr::spread(key = payment_method, value = count, fill = 0)

# Convertir los datos en formato adecuado para la gráfica radar
radar_data <- as.data.frame(rbind(
  rep(max(summary_data[,-1], na.rm = TRUE), ncol(summary_data)-1),  # Fila de valores máximos
  rep(0, ncol(summary_data)-1),  # Fila de valores mínimos
  summary_data[,-1]  # Datos originales
))

# Asignar nombres de filas
rownames(radar_data) <- c("Max", "Min", as.character(summary_data$gender))

# Ajustar la gráfica radar con mejor visualización
par(mar = c(2, 2, 2, 2))  # Ajustar márgenes
radarchart(radar_data, axistype = 1,
           pcol = c("#FF5733", "#1F77B4"),  # Colores de las líneas
           pfcol = c(alpha("#FF5733", 0.4), alpha("#1F77B4", 0.4)),  # Mayor transparencia en el relleno
           plwd = 3, plty = 1,  # Líneas más gruesas
           cglcol = "grey", cglty = 2, cglwd = 0.7,  # Líneas guía más suaves
           axislabcol = "black",  # Etiquetas de los ejes en negro
           vlcex = 1.2,  # Tamaño más grande para los nombres de las variables
           title = "Figura 31. Metodo de Pago por Genero")  # Título más claro

# Añadir leyenda mejor alineada
legend("bottom", legend = as.character(summary_data$gender), 
       col = c("#FF5733", "#1F77B4"), pch = 16, cex = 1.2, bty = "n", horiz = TRUE)
```



```{r}

# Crear una nueva columna para segmentar las edades en varios rangos
data <- datosNA %>%
  mutate(age = case_when(
    age >= 18 & age <= 30 ~ "18-30 year",
    age >= 31 & age <= 50 ~ "31-50 year",
    age >= 51 & age <= 70 ~ "51-70 year",
    age > 70 ~ "71+ year",
    TRUE ~ "Otro"
  )) 

# Resumir los datos por categoría y grupo de edad
resumen_categoria <- data %>%
  group_by(payment_method, age) %>%
  summarise(total_quantity = sum(quantity), .groups = "drop")


# Crear un gráfico apilado para visualizar la demanda por categoría y grupo de edad
ggplot(resumen_categoria, aes(x = payment_method, y = total_quantity, fill = age)) +
  geom_bar(stat = "identity") +
  labs(title = "Figura 31.1 Demanda por categoria y grupo de edad",
       x = "categoria",
       y = "Cantidad total de productos vendidos") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3")
```




```{r}

# Ver el resumen de las categorías por grupo de edad
print(resumen_categoria)
```




### Distribución del Consumo en Centros Comerciales

Los principales centros comerciales en Estambul presentan variaciones en las preferencias de consumo. Los centros comerciales de lujo como Mall of Istanbul y Kanion atraen a consumidores con un mayor poder adquisitivo, centrados en ropa y shoes muestran mayores ingresos, y los centros comerciales populares muestran menos ingresos como Emaar Square Mall,Zorlu Center, Forum Istanbul, Cevahir AVM y Viaport Outlet presenta el mismo comportamiento de publico objetivo con estos gustos pero con menores ventas como se muestra `Figura 32` y `Figura 33`.


```{r}

###Calcular el ingreso total por cada transacción
data <- datosNA %>%
  mutate(income = quantity * price) # Crear una nueva columna de ingresos

# Resumir los ingresos totales por centro comercial
total_income <- data %>%
  group_by(shopping_mall) %>%
  summarise(total_income = sum(income, na.rm = TRUE))

# Ver los resultados
print(total_income)

ggplot(total_income, aes(x = reorder(shopping_mall, total_income), y = total_income, fill = shopping_mall)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  labs(title = "Figura 32. Ingresos Totales por Centro Comercial", 
       x = "Centro Comercial", 
       y = "Ingreso Total (TL)") +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}

resumen <- datosNA %>%
  group_by(shopping_mall, category) %>%
  summarise(total_sales = sum(quantity * price)) %>%
  ungroup()

ggplot(resumen, aes(x = shopping_mall, y = total_sales, fill = category)) +
  geom_bar(stat = "identity", position = "stack") +  # Las barras se apilan
  labs(
    title = "Figura 33. Ventas por Categoria en Cada Centro Comercial",
    x = "Centro Comercial",
    y = "Ventas Totales (en Liras Turcas)",
    fill = "Categoria"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  
    strip.text = element_text(size = 10)  
  )

```



### Conclusiones y Tendencias Futuras

Los patrones de consumo en Estambul reflejan una población diversa con una fuerte inclinación hacia la ropa, cosmeticos y la alimentación. Se proyecta un aumento en el uso de pagos digitales y un crecimiento continuo en el segmento de e-commerce. Además, la segmentación por tipo de centro comercial sugiere que las estrategias de venta deben adaptarse según el perfil del consumidor en cada ubicación.

el consumo en stambull sugiere que los zapatos y la ropa son un habito de consumo en cuanto costos de los habitantes, se sugiere publicidad para los centros comerciales de estos producto para optimizar ventas.

Este análisis permite a las empresas y comerciantes tomar decisiones informadas sobre sus estrategias de mercado, optimizando la oferta de productos y los métodos de pago para maximizar la experiencia del cliente en la ciudad de Estambul.

La categoria ropa y cosmeticos tienen una mayor demanda en el segmento de 31 a 50 años, por lo que las campañas de publicidad deberían enfocarse en adultos de mediana edad.

Alimentos y libros presentan una distribución más equilibrada, pero la demanda sigue siendo ligeramente mayor en el grupo de 31 a 50 años, lo que hace este grupo una audiencia clave para cualquier campaña de marketing o promoción en centros comerciales.

### Recomendaciones tecnicas de la informacion

Se evidencia que la variable invoice_date no indica transaccionalidad se recomienda almacenar la informacion con formato timestamp.

Se recomineda una columna adicional con id_producto.

